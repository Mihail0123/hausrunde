<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hausrunde Test Frontend</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:24px;
           display:flex; justify-content:center; }
    .container { width: 100%; max-width: 980px; background:#fff; border-radius:14px; padding:24px;
                 box-shadow:0 8px 24px rgba(0,0,0,.08); }
    h1, h2 { text-align:center; margin:0 0 16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    input, select, button, textarea { padding:8px 10px; border:1px solid #ccc; border-radius:8px; }
    button { cursor:pointer; }
    .btn { background:#111; color:#fff; }
    .btn-outline { background:#fff; border:1px solid #111; }
    .tabs { display:flex; justify-content:center; gap:8px; margin:16px 0; }
    .tab { background:#eee; border:none; padding:8px 14px; border-radius:999px; }
    .tab.active { background:#111; color:#fff; }
    .section { display:none; }
    .section.active { display:block; }
    .hr { height:1px; background:#e5e5e5; margin:16px 0; }
    .card { border:1px solid #e7e7e7; border-radius:10px; padding:14px; margin:10px 0; background:#fff; }
    .muted { color:#666; font-size:13px; }
    .right { text-align:right; }
    .center { text-align:center; }
    dialog { border:none; border-radius:12px; padding:0; }
    dialog::backdrop { background:rgba(0,0,0,.35); }
    .modal { padding:18px; min-width:320px; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #ddd; }
    .chip { font-size:13px; padding:4px 10px; border:1px solid #ddd; border-radius:999px; background:#fafafa; cursor:pointer; }
    .grid { display:grid; gap:10px; }
    @media (min-width: 750px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
      .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
    }
    .rating { font-size:13px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Hausrunde Test Frontend</h1>

  <!-- AUTH -->
  <section id="auth">
    <h2>Login</h2>
    <div class="row center">
      <input id="email" type="email" placeholder="Email" style="min-width:240px">
      <input id="password" type="password" placeholder="Password" style="min-width:200px">
      <button id="loginBtn" class="btn">Login</button>
      <button id="logoutBtn" class="btn-outline">Logout</button>
    </div>
    <div id="authStatus" class="center muted" style="margin-top:8px"></div>
  </section>

  <!-- REGISTER -->
  <h2>Register</h2>
  <form id="registerForm" class="row center" style="margin-bottom:16px">
    <input type="email" name="email" placeholder="Email" required style="min-width:240px">
    <input type="password" name="password" placeholder="Password" required style="min-width:200px">
    <button type="submit" class="btn">Register</button>
  </form>
  <div id="registerMsg" class="center muted" style="margin-top:8px"></div>

  <!-- TABS -->
  <div class="tabs" id="tabs" style="display:none;">
    <button class="tab active" data-tab="tab-ads">Ads</button>
    <button class="tab" data-tab="tab-myads">My Ads</button>
    <button class="tab" data-tab="tab-bookings">My Bookings</button>
  </div>

  <!-- ADS (public with filters + create) -->
  <section id="tab-ads" class="section active">
    <h2>Ads</h2>

    <!-- Top searches -->
    <div id="topSearches" class="row" style="margin:8px 0 14px; display:none;"></div>

    <!-- Filters -->
    <form id="adsFilter" class="grid grid-3">
      <input name="q" placeholder="Search (q)">
      <input name="location" placeholder="Location">
      <input name="housing_type" placeholder="Housing type">

      <input name="price_min" type="number" placeholder="Price min">
      <input name="price_max" type="number" placeholder="Price max">
      <select name="ordering">
        <option value="">Ordering</option>
        <option value="price">price ↑</option>
        <option value="-price">price ↓</option>
        <option value="created_at">created_at ↑</option>
        <option value="-created_at">created_at ↓</option>
        <option value="-views_count">most viewed</option>
        <option value="-reviews_count">most reviewed</option>
      </select>

      <input name="rooms_min" type="number" placeholder="Rooms min">
      <input name="rooms_max" type="number" placeholder="Rooms max">
      <select name="page_size">
        <option value="10">10 / page</option>
        <option value="20">20 / page</option>
        <option value="30">30 / page</option>
        <option value="50">50 / page</option>
      </select>

      <div class="row">
        <button class="btn" type="submit">Search</button>
        <button class="btn-outline" type="button" id="resetAds">Reset</button>
      </div>
    </form>

    <div id="adsList"></div>
    <div class="row" id="adsPager" style="justify-content:space-between; align-items:center;"></div>

    <div class="hr"></div>

    <!-- Create Ad -->
    <h3 class="center">Create Ad</h3>
    <form id="adCreate" class="grid grid-2">
      <input name="title" placeholder="Title" required>
      <input name="location" placeholder="Location">
      <textarea name="description" placeholder="Description" rows="3" style="grid-column:1 / -1"></textarea>
      <input name="price" type="number" placeholder="Price">
      <input name="rooms" type="number" placeholder="Rooms">
      <input name="housing_type" placeholder="Housing type">
      <label class="muted"><input type="checkbox" name="is_active" checked> Active</label>
      <button class="btn" type="submit">Create</button>
    </form>
    <div id="adCreateMsg" class="center muted"></div>
  </section>

  <!-- MY ADS -->
  <section id="tab-myads" class="section">
    <h2>My Ads</h2>
    <div id="myAdsList" class="muted center">Login to see your ads.</div>
  </section>

  <!-- BOOKINGS -->
  <section id="tab-bookings" class="section">
    <h2>My Bookings</h2>

    <form id="bookingCreate" class="row">
      <input name="ad" type="number" placeholder="Ad ID" required>
      <input name="date_from" type="date" required>
      <input name="date_to" type="date" required>
      <button class="btn" type="submit">Create Booking</button>
    </form>
    <div id="bookingCreateMsg" class="center muted"></div>

    <div id="bookingsList" class="muted center">Login to see your bookings.</div>
  </section>
</div>

<!-- Booking modal -->
<dialog id="bookModal">
  <form id="bookForm" class="modal">
    <h3>Book this ad</h3>
    <input type="hidden" name="ad" id="bookAdId">
    <div class="row">
      <input type="date" name="date_from" required>
      <input type="date" name="date_to" required>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button type="button" class="btn-outline" id="bookCancel">Cancel</button>
      <button class="btn">Book</button>
    </div>
    <div id="bookMsg" class="muted" style="margin-top:8px"></div>
  </form>
</dialog>

<!-- Reviews modal -->
<dialog id="reviewsModal">
  <div class="modal" style="min-width:520px">
    <h3>Reviews for Ad <span id="revAdId"></span></h3>
    <div id="reviewsList" class="muted">Loading…</div>
    <div class="hr"></div>
    <form id="reviewForm" class="grid grid-2" style="margin-top:6px; display:none;">
      <input type="hidden" name="ad" id="reviewAdId">
      <select name="rating" required>
        <option value="">Rating 1–5</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
      <span class="muted" style="align-self:center;">Only after finished confirmed booking</span>
      <textarea name="text" rows="3" placeholder="Your comment (optional)" style="grid-column:1 / -1"></textarea>
      <div class="row" style="justify-content:flex-end; grid-column:1 / -1">
        <button type="button" class="btn-outline" id="reviewsClose">Close</button>
        <button class="btn">Send review</button>
      </div>
      <div id="reviewMsg" class="muted" style="grid-column:1 / -1"></div>
    </form>
  </div>
</dialog>

<!-- Ad details modal -->
<dialog id="adModal">
  <div class="modal" style="min-width:680px; max-width:900px">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h3 id="adTitle" style="margin:0;">Ad</h3>
      <button type="button" class="btn-outline" id="adClose">Close</button>
    </div>
    <div id="adMeta" class="muted" style="margin:6px 0 12px;"></div>
    <div id="adGallery" class="row" style="gap:8px; overflow:auto;"></div>
    <div id="adDesc" class="muted" style="margin:12px 0;"></div>
    <div class="row" style="justify-content:flex-end; gap:8px; margin-top:10px;">
      <button class="btn-outline" id="adReviewsBtn">Reviews</button>
      <button class="btn" id="adBookBtn">Book</button>
    </div>
  </div>
</dialog>

<script>
  // ======== STATE ========
  var access = null;                 // JWT access token
  var currentEmail = null;
  var adsPage = 1;
  var API = "/api";

  // ======== HELPERS ========
  function hAuth() { return access ? { "Authorization": "Bearer " + access } : {}; }
  function enc(obj) { return new URLSearchParams(obj).toString(); }
  function esc(s){return String(s||'').replace(/[&<>"']/g,function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);})}
  function showTabs(show){ document.getElementById('tabs').style.display = show ? 'flex' : 'none'; }
  function setAuthStatus(txt){ document.getElementById('authStatus').textContent = txt || ''; }
  function fmtAvg(x){ var n = Number(x); return isFinite(n) ? n.toFixed(1) : '—'; }
  function emailsEqual(a, b){ return !!a && !!b && String(a).toLowerCase() === String(b).toLowerCase(); }

  // tabs
  Array.prototype.forEach.call(document.querySelectorAll('.tab'), function(b){
    b.addEventListener('click', function(){
      Array.prototype.forEach.call(document.querySelectorAll('.tab'), function(x){ x.classList.remove('active'); });
      Array.prototype.forEach.call(document.querySelectorAll('.section'), function(x){ x.classList.remove('active'); });
      b.classList.add('active');
      document.getElementById(b.getAttribute('data-tab')).classList.add('active');
    });
  });

  // ======== AUTH ========
  document.getElementById('loginBtn').addEventListener('click', async function(){
    var email = document.getElementById('email').value.trim();
    var password = document.getElementById('password').value;
    var res = await fetch(API + "/token/", {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email: email, password: password })
    });
    if(res.ok){
      var data = await res.json();
      access = data.access;
      currentEmail = email;
      setAuthStatus('✅ Logged in as ' + email);
      showTabs(true);
      loadTopSearches();
      loadAds(); loadMyAds(); loadBookings();
    } else {
      setAuthStatus('❌ Login failed');
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', function(){
    access = null; currentEmail = null;
    setAuthStatus('Logged out');
    showTabs(false);
  });

  // REGISTER
  document.getElementById('registerForm').addEventListener('submit', async function(e){
    e.preventDefault();
    var fd = new FormData(e.target);
    var payload = Object.fromEntries(fd.entries());

    var res = await fetch(API + "/users/register/", {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    var msg = document.getElementById('registerMsg');
    if(res.ok){
      msg.textContent = "✅ Registration successful! You can login now.";
      e.target.reset();
    } else {
      var err = {};
      try { err = await res.json(); } catch(e){}
      msg.textContent = "❌ Failed: " + (err.detail || JSON.stringify(err));
    }
  });

  // ======== TOP SEARCHES ========
  async function loadTopSearches(){
    var box = document.getElementById('topSearches');
    var res = await fetch(API + "/search-history/top/?limit=10");
    if(!res.ok){ box.style.display='none'; return; }
    var items = await res.json(); // [{q:'', count:n}]
    if(!items.length){ box.style.display='none'; return; }
    box.style.display='flex';
    box.innerHTML = '<span class="muted">Top searches:</span>' +
      items.map(function(i){ return '<span class="chip" data-q="' + esc(i.q) + '">' + esc(i.q||'(empty)') + ' · ' + i.count + '</span>'; }).join('');
    Array.prototype.forEach.call(box.querySelectorAll('.chip'), function(ch){
      ch.addEventListener('click', function(){
        var q = ch.getAttribute('data-q') === '(empty)' ? '' : ch.getAttribute('data-q');
        var f = document.getElementById('adsFilter');
        f.q.value = q || '';
        adsPage = 1;
        loadAds();
      });
    });
  }

  // ======== ADS LIST + FILTERS ========
  var adsList = document.getElementById('adsList');
  var adsPager = document.getElementById('adsPager');

  async function loadAds(paramsStr){
    var filterForm = document.getElementById('adsFilter');
    var fd = new FormData(filterForm);
    if(paramsStr){ /* external */ }
    else { fd.set('page', String(adsPage)); paramsStr = enc(Object.fromEntries(fd)); }
    var res = await fetch(API + "/ads/?" + paramsStr, { headers: hAuth() });
    if(!res.ok){ adsList.innerHTML = '<div class="center muted">Error ' + res.status + '</div>'; return; }
    var data = await res.json();
    renderAds(data.results || []);
    renderAdsPager(data.count || 0, Number(fd.get('page_size')||10));
  }

  function renderAds(items){
    if(!items.length){ adsList.innerHTML = '<div class="center muted">No ads found.</div>'; return; }
    adsList.innerHTML = items.map(function(ad){
      var own = emailsEqual(currentEmail, ad.owner); // если owner не придёт — own=false
      return '\
      <div class="card ad-card" data-ad="'+ ad.id +'" style="cursor:pointer;">\
        <div class="row" style="justify-content:space-between; align-items:flex-start">\
          <div>\
            <div><b>'+ esc(ad.title) +'</b></div>\
            <div class="muted">'+ esc(ad.location) +' · '+ ad.rooms +' rooms · '+ esc(ad.housing_type||'') +'</div>\
            <div class="rating">⭐ '+ fmtAvg(ad.average_rating) +'\
              · 👁 '+ Number(ad.views_count || 0) +'\
              · 💬 '+ Number(ad.reviews_count || 0) +'\
            </div>\
          </div>\
          <div class="right">\
            <div style="font-weight:700">€'+ Number(ad.price).toLocaleString() +'</div>\
            <div class="muted">ID: '+ ad.id +'</div>\
          </div>\
        </div>\
        <div class="muted" style="margin-top:6px">'+ esc(ad.description||'') +'</div>\
        <div class="row" style="justify-content:flex-end; margin-top:8px">\
          <button class="btn-outline" data-ad="'+ ad.id +'" data-action="reviews" onclick="event.stopPropagation()">Reviews</button>\
          '+ (own ? '' : '<button class="btn-outline" data-ad="'+ ad.id +'" data-action="book" onclick="event.stopPropagation()">Book</button>') + '\
        </div>\
      </div>';
    }).join('');

    // Card -> details
    Array.prototype.forEach.call(adsList.querySelectorAll('.ad-card'), function(card){
      card.addEventListener('click', function(){
        var id = Number(card.getAttribute('data-ad'));
        openAdModal(id);
      });
    });

    // Book handlers
    Array.prototype.forEach.call(adsList.querySelectorAll('button[data-action="book"]'), function(btn){
      btn.addEventListener('click', function(){
        if(!access){ alert('Please login first'); return; }
        document.getElementById('bookAdId').value = btn.getAttribute('data-ad');
        document.getElementById('bookMsg').textContent = '';
        document.getElementById('bookModal').showModal();
      });
    });

    // Reviews handlers
    Array.prototype.forEach.call(adsList.querySelectorAll('button[data-action="reviews"]'), function(btn){
      btn.addEventListener('click', function(){
        openReviewsModal(Number(btn.getAttribute('data-ad')));
      });
    });
  }

  function renderAdsPager(count, pageSize){
    var total = Math.max(1, Math.ceil(count / pageSize));
    adsPager.innerHTML = '\
      <div class="muted">Total: '+ count +'</div>\
      <div class="row">\
        <button class="btn-outline" id="prevAds" '+ (adsPage<=1?'disabled':'') +'>Prev</button>\
        <div class="muted" style="padding:8px 12px">Page '+ adsPage +' / '+ total +'</div>\
        <button class="btn-outline" id="nextAds" '+ (adsPage>=total?'disabled':'') +'>Next</button>\
      </div>';
    var prev = document.getElementById('prevAds');
    var next = document.getElementById('nextAds');
    if(prev){ prev.addEventListener('click', function(){ adsPage=Math.max(1, adsPage-1); loadAds(); }); }
    if(next){ next.addEventListener('click', function(){ adsPage=adsPage+1; loadAds(); }); }
  }

  document.getElementById('adsFilter').addEventListener('submit', function(e){
    e.preventDefault(); adsPage=1; loadAds();
  });
  document.getElementById('resetAds').addEventListener('click', function(){
    document.getElementById('adsFilter').reset(); adsPage=1; loadAds();
  });

  // ======== CREATE AD ========
  document.getElementById('adCreate').addEventListener('submit', async function(e){
    e.preventDefault();
    if(!access){ alert('Login required'); return; }
    var fd = new FormData(e.target);
    var payload = Object.fromEntries(fd.entries());
    payload.price = payload.price ? Number(payload.price) : null;
    payload.rooms = payload.rooms ? Number(payload.rooms) : null;
    payload.is_active = !!fd.get('is_active');
    var res = await fetch(API + "/ads/", {
      method:'POST', headers:Object.assign({}, hAuth(), {'Content-Type':'application/json'}),
      body: JSON.stringify(payload)
    });
    var msg = document.getElementById('adCreateMsg');
    if(res.ok){ msg.textContent='✅ Ad created'; e.target.reset(); loadAds(); loadMyAds(); }
    else { msg.textContent='❌ Failed to create'; }
  });

  // ======== MY ADS ========
  async function loadMyAds(){
    var box = document.getElementById('myAdsList');
    if(!access || !currentEmail){ box.textContent='Login to see your ads.'; return; }
    var res = await fetch(API + "/ads/?mine=true&page_size=50", { headers: hAuth() });
    if(!res.ok){ box.textContent='Error loading'; return; }
    var data = await res.json();
    var mine = data.results || [];
    if(!mine.length){ box.textContent='No ads yet.'; return; }

    box.innerHTML = mine.map(function(ad){
      return '\
      <div class="card myad-card" data-ad="'+ ad.id +'" style="cursor:pointer;">\
        <div class="row" style="justify-content:space-between">\
          <div><b>'+ esc(ad.title) +'</b><div class="muted">'+ esc(ad.location) +'</div></div>\
          <div class="right">\
            <div style="font-weight:700">€'+ Number(ad.price).toLocaleString() +'</div>\
            <div class="muted">ID: '+ ad.id +'</div>\
          </div>\
        </div>\
      </div>';
    }).join('');

    // клик по моей карточке -> модалка объявления
    Array.prototype.forEach.call(box.querySelectorAll('.myad-card'), function(card){
      card.addEventListener('click', function(){
        var id = Number(card.getAttribute('data-ad'));
        openAdModal(id);
      });
    });
  }

  // ======== BOOKINGS ========
  async function loadBookings(){
    var box = document.getElementById('bookingsList');
    if(!access){ box.textContent='Login to see your bookings.'; return; }
    var res = await fetch(API + "/bookings/", { headers:hAuth() });
    if(!res.ok){ box.textContent='Error loading'; return; }
    var list = await res.json();
    if(!list.length){ box.textContent='No bookings yet.'; return; }

    // owners cache
    var adOwnersCache = {};
    async function getAdOwner(adId){
      if(adOwnersCache[adId]) return adOwnersCache[adId];
      var r = await fetch(API + "/ads/" + adId + "/");
      if(!r.ok) return null;
      var ad = await r.json();
      adOwnersCache[adId] = ad.owner || null;
      return adOwnersCache[adId];
    }

    box.innerHTML = '';
    for (var i=0; i<list.length; i++){
      var b = list[i];
      var ownerEmail = await getAdOwner(b.ad);
      var iAmOwner = currentEmail && ownerEmail && currentEmail.toLowerCase() === ownerEmail.toLowerCase();
      var iAmTenant = currentEmail && b.tenant && currentEmail.toLowerCase() === b.tenant.toLowerCase();

      var el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = '\
        <div class="row" style="justify-content:space-between">\
          <div>\
            <div><b>Booking #'+ b.id +'</b> · <span class="pill">'+ esc(b.status) +'</span></div>\
            <div class="muted">Ad: '+ b.ad +' · '+ esc(b.date_from) +' → '+ esc(b.date_to) +'</div>\
            <div class="muted">Tenant: '+ esc(b.tenant || '') +' · Owner: '+ esc(ownerEmail || '') +'</div>\
          </div>\
          <div class="row">\
            '+ (iAmOwner && b.status==='PENDING' ? '\
              <button class="btn-outline" data-act="confirm" data-id="'+ b.id +'">Confirm</button>\
              <button class="btn-outline" data-act="reject" data-id="'+ b.id +'">Reject</button>' : '') +'\
            '+ (iAmTenant && b.status!=='CANCELLED' ? '\
              <button class="btn-outline" data-act="cancel" data-id="'+ b.id +'">Cancel</button>' : '') +'\
          </div>\
        </div>';
      box.appendChild(el);
    }

    // handlers
    Array.prototype.forEach.call(box.querySelectorAll('button[data-act]'), function(btn){
      btn.addEventListener('click', async function(){
        var id = btn.getAttribute('data-id'), act = btn.getAttribute('data-act');
        var r = await fetch(API + "/bookings/" + id + "/" + act + "/", { method:'POST', headers:hAuth() });
        if(!r.ok) alert('Action failed ('+act+')');
        await loadBookings();
      });
    });
  }

  // Create booking (form)
  const bookModal = document.getElementById('bookModal');
  document.getElementById('bookCancel').addEventListener('click', function(){ bookModal.close(); });
  document.getElementById('bookForm').addEventListener('submit', async function(e){
    e.preventDefault();
    if(!access){ alert('Login required'); return; }
    var fd = new FormData(e.target);
    var payload = Object.fromEntries(fd.entries());
    var res = await fetch(API + "/bookings/", {
      method:'POST', headers:Object.assign({}, hAuth(), {'Content-Type':'application/json'}),
      body: JSON.stringify(payload)
    });
    var msg = document.getElementById('bookMsg');
    if(res.ok){ msg.textContent='✅ Booking created'; setTimeout(function(){ bookModal.close(); loadBookings(); }, 600); }
    else { msg.textContent='❌ Failed to create booking'; }
  });

  // ======== REVIEWS ========
  const reviewsModal = document.getElementById('reviewsModal');
  const reviewsList  = document.getElementById('reviewsList');
  const reviewForm   = document.getElementById('reviewForm');
  const reviewMsg    = document.getElementById('reviewMsg');
  document.getElementById('reviewsClose').addEventListener('click', ()=> reviewsModal.close());

  async function openReviewsModal(adId){
    document.getElementById('revAdId').textContent = adId;
    document.getElementById('reviewAdId').value = adId;
    reviewMsg.textContent = '';
    reviewsList.innerHTML = 'Loading…';
    reviewsModal.showModal();

    // Показывать форму только если залогинен и это НЕ моё объявление
    let showForm = !!access;
    if (showForm) {
      try {
        const r = await fetch(`${API}/ads/${adId}/`);
        if (r.ok) {
          const ad = await r.json();
          const isOwner = currentEmail && ad.owner &&
            currentEmail.toLowerCase() === String(ad.owner).toLowerCase();
          showForm = !isOwner;
        }
      } catch(_) {}
    }
    reviewForm.style.display = showForm ? 'grid' : 'none';

    await loadReviews(adId);
  }

  async function loadReviews(adId){
    const res = await fetch(`${API}/reviews/?ad=${adId}&ordering=-created_at`);
    if(!res.ok){ reviewsList.textContent = 'Failed to load reviews'; return; }
    const full = await res.json();
    const items = full.results || (Array.isArray(full) ? full : []);
    if(!items.length){ reviewsList.innerHTML = '<div class="muted">No reviews yet.</div>'; return; }
    const avg = (items.reduce((s, r)=> s + Number(r.rating||0), 0) / items.length).toFixed(1);
    reviewsList.innerHTML = `
      <div class="rating">⭐ ${avg} · ${items.length} review(s)</div>
      <div style="margin-top:8px;"></div>
      ${items.map(r => `
        <div class="card" style="margin:8px 0;">
          <div><b>${esc(r.tenant || '')}</b> · <span class="pill">${esc(r.rating)}/5</span></div>
          <div class="muted">${esc(r.text || '')}</div>
          <div class="muted">${esc(r.created_at || '')}</div>
        </div>`).join('')}
    `;
  }

  // ВАЖНО: предотвращаем перезагрузку страницы при отправке формы
  reviewForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!access){ alert('Login required'); return; }
    const fd = new FormData(reviewForm);
    const payload = Object.fromEntries(fd.entries());
    payload.rating = Number(payload.rating);

    const res = await fetch(`${API}/reviews/`, {
      method:'POST',
      headers:{ ...hAuth(), 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    if(res.ok){
      reviewMsg.textContent = '✅ Review added';
      reviewForm.reset();
      await loadReviews(document.getElementById('reviewAdId').value);
    } else {
      let err = {};
      try { err = await res.json(); } catch {}
      reviewMsg.textContent = '❌ ' + (err.detail || (err.non_field_errors && err.non_field_errors[0]) || JSON.stringify(err));
      if (res.status === 401) {
        // токен истёк — просим перелогиниться
        access = null; currentEmail = null; showTabs(false);
        setAuthStatus('Session expired — please login again.');
      }
    }
  });

  // ======== AD DETAILS MODAL ========
  const adModal = document.getElementById('adModal');
  const adClose = document.getElementById('adClose');
  const adTitle = document.getElementById('adTitle');
  const adMeta  = document.getElementById('adMeta');
  const adDesc  = document.getElementById('adDesc');
  const adGallery = document.getElementById('adGallery');
  const adBookBtn = document.getElementById('adBookBtn');
  const adReviewsBtn = document.getElementById('adReviewsBtn');

  adClose.addEventListener('click', function(){ adModal.close(); });

  async function openAdModal(adId){
    // GET /api/ads/{id}/ — backend создаст AdView с дедупом 6h
    var res = await fetch(API + "/ads/" + adId + "/");
    if(!res.ok){ alert('Failed to load ad'); return; }
    var ad = await res.json();

    adTitle.textContent = ad.title || ('Ad #' + adId);
    adMeta.innerHTML = ''
      + '<span>' + esc(ad.location || '') + '</span>'
      + ' · <span>' + (ad.rooms || 0) + ' rooms</span>'
      + ' · <span>' + esc(ad.housing_type || '') + '</span>'
      + ' · <b>€' + Number(ad.price).toLocaleString() + '</b>'
      + '<br>'
      + '<span class="rating">⭐ ' + fmtAvg(ad.average_rating) + '</span>'
      + ' · <span>👁 ' + Number(ad.views_count || 0) + '</span>'
      + ' · <span>💬 ' + Number(ad.reviews_count || 0) + '</span>';

    adDesc.textContent = ad.description || '';

    if(Array.isArray(ad.images) && ad.images.length){
      adGallery.innerHTML = ad.images.map(function(img){
        return '<img src="' + img.image + '" alt="' + esc(img.caption||'') + '" style="height:120px; border-radius:8px; border:1px solid #eee;">';
      }).join('');
    } else {
      adGallery.innerHTML = '<div class="muted">No images.</div>';
    }

    var isOwner = emailsEqual(currentEmail, ad.owner);

    // "Book": скрыть, если это моё объявление
    adBookBtn.style.display = isOwner ? 'none' : 'inline-block';
    adBookBtn.onclick = function(e){
      e.preventDefault();
      if(!access){ alert('Please login first'); return; }
      document.getElementById('bookAdId').value = adId;
      document.getElementById('bookMsg').textContent = '';
      bookModal.showModal();
    };

    // "Reviews": список всегда; форма только если не владелец
    adReviewsBtn.onclick = function(e){
      e.preventDefault();
      openReviewsModal(adId, { isOwner: isOwner });
    };

    adModal.showModal();
  }

  // ======== INIT ========
  loadTopSearches();
  loadAds();
</script>
</body>
</html>
